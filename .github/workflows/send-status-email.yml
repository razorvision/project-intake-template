name: Send Status Report Email

on:
  pull_request:
    types: [closed]
    branches: [master, main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'send_to_all'
        type: choice
        options:
          - send_test
          - send_to_all

jobs:
  send-email:
    name: Send Email
    # Only run if PR was merged (closed + merged = true), or manual dispatch
    if: |
      (github.event.pull_request.merged == true &&
       startsWith(github.event.pull_request.title, 'Status Report')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm install

      - name: Send test email to me
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'send_test')
        run: node scripts/send-email.mjs
        env:
          GMAIL_FROM_EMAIL: ${{ secrets.GMAIL_FROM_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.GMAIL_FROM_EMAIL }}
          IS_TEST_EMAIL: 'true'
          APPROVAL_TOKEN_SECRET: ${{ secrets.APPROVAL_TOKEN_SECRET }}
          VERCEL_DEPLOYMENT_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}

      - name: Send email to all recipients
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'send_to_all'
        run: node scripts/send-email.mjs
        env:
          GMAIL_FROM_EMAIL: ${{ secrets.GMAIL_FROM_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}

      - name: Post test email comment
        if: (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'send_test')) && success()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `üìß **Test email sent!**\n\nCheck your inbox for the status report with an approval button at the top. Click the button to send to all recipients.\n\nIf you don't see the button, the approval flow may not be configured yet. Check the workflow logs for details.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Post success comment (to all)
        if: github.event_name == 'workflow_dispatch' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Status report email sent successfully to all recipients!'
            })

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Failed to send status report email. Check workflow logs for details.'
            })
