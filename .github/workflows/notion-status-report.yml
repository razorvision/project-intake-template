name: Generate Notion Status Report

on:
  schedule:
    # Run every Monday, Wednesday, Friday at 8 AM CT (2 PM UTC / 14:00 UTC)
    - cron: '0 14 * * 1,3,5'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  generate-report:
    name: Generate Status Report
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm install

      - name: Fetch Notion data
        run: node scripts/fetch-notion-data.mjs
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

      - name: Generate HTML report
        run: node scripts/generate-report.mjs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Update Notion status report'
          title: 'Status Report - ${{ github.event.repository.updated_at }}'
          add-paths: |
            NOTION_PROJECT_STATUS.html
            data/notion-raw.json
          body: |
            ## Automated Status Report

            This PR contains the latest Notion project status report, automatically generated from the Product Features board.

            **Generated:** ${{ job.status }}

            ### Review Checklist
            - [ ] Report content is accurate
            - [ ] No internal RV 2.0 items included (only CBB, DLC, Wise Loan)
            - [ ] All issues properly categorized by priority
            - [ ] Ready to send to stakeholders

            ### Next Steps
            Merge this PR to trigger automatic email delivery to stakeholders.

            ---
            ðŸ¤– Generated automatically by GitHub Actions on schedule
          branch: automated-status-report
          delete-branch: true
          labels: automated, status-report
